# Arbores Scheme 解释器开发计划

## 第一阶段：基础架构 (1-2 周)

### 1.1 数据类型定义
- [x] 定义核心数据类型枚举 `Value`
- [x] 实现数字类型（整数、浮点数）
- [x] 实现字符串和符号类型
- [x] 实现列表类型（cons cell）
- [x] 实现布尔值和 nil
- [x] 为所有类型实现 Display trait

### 1.2 词法分析器 (Lexer)
- [x] 定义 Token 枚举
- [x] 实现字符流处理
- [x] 支持数字解析（整数、浮点数）
- [x] 支持字符串字面量（转义字符）
- [x] 支持符号和关键字识别
- [x] 支持括号和引号
- [x] 支持注释（`;` 开头）
- [ ] 错误处理和位置信息

### 1.3 语法分析器 (Parser)
- [x] 实现 S-表达式解析
- [x] 支持嵌套列表结构
- [x] 支持引用语法 `'expr`
- [x] 支持准引用语法 `` `expr``
- [x] 支持反引用语法 `,expr` 和 `,@expr`
- [x] 错误恢复和报告
- [ ] 语法树优化

## 第二阶段：核心求值器 (2-3 周)

### 2.1 环境管理
- [x] 实现环境链结构
- [x] 支持变量绑定和查找
- [x] 支持作用域嵌套
- [x] 实现环境克隆和扩展

### 2.2 基础求值器
- [x] 实现 `eval` 函数核心逻辑
- [x] 支持自求值表达式（数字、字符串、布尔值）
- [x] 支持变量查找
- [x] 支持函数调用
- [x] 实现特殊形式框架

### 2.3 特殊形式实现
- [x] `quote` - 引用
- [x] `if` - 条件表达式
- [~] `define` - 变量定义 (需要 RefCell 重构)
- [x] `lambda` - 函数定义
- [x] `let` 和 `let*` - 局部绑定
- [ ] `cond` - 多分支条件
- [ ] `and` 和 `or` - 逻辑运算（短路求值）
- [x] `begin` - 顺序求值

## 第三阶段：内置函数库 (1-2 周)

### 3.1 算术运算
- [x] `+`, `-`, `*`, `/` - 基本算术
- [x] `=`, `<`, `>`, `<=`, `>=` - 比较运算
- [ ] `abs`, `max`, `min` - 数学函数
- [ ] `quotient`, `remainder`, `modulo` - 整数运算

### 3.2 列表操作
- [x] `cons` - 构造列表
- [x] `car`, `cdr` - 列表访问
- [x] `list` - 创建列表
- [ ] `length` - 列表长度
- [ ] `append` - 列表拼接
- [ ] `reverse` - 列表反转
- [ ] `member`, `assoc` - 列表搜索

### 3.3 类型谓词
- [x] `null?`, `pair?`, `list?`
- [x] `number?`, `string?`, `symbol?`
- [ ] `procedure?`, `boolean?`

### 3.4 字符串操作
- [ ] `string-length`, `string-ref`
- [ ] `string-append`, `substring`
- [ ] `string->symbol`, `symbol->string`

## 第四阶段：高级特性 (2-3 周)

### 4.1 REPL (Read-Eval-Print Loop)
- [x] 实现交互式命令行界面
- [x] 支持多行输入
- [x] 历史记录和自动补全
- [x] 错误处理和恢复
- [x] 调试信息显示

### 4.2 尾递归优化
- [ ] 识别尾调用位置
- [ ] 实现尾调用优化
- [ ] 支持尾递归函数

### 4.3 闭包和高阶函数
- [x] 实现词法闭包
- [x] 支持函数作为一等公民
- [ ] 实现 `map`, `filter`, `fold` 等高阶函数

### 4.4 错误处理
- [x] 设计统一的错误类型
- [x] 实现错误传播机制
- [ ] 提供详细的错误信息（行号、列号）
- [ ] 支持异常处理（可选）

## 第五阶段：扩展功能 (可选，2-4 周)

### 5.1 宏系统
- [ ] 实现 `define-syntax` 
- [ ] 支持模式匹配
- [ ] 实现卫生宏
- [ ] 提供常用宏（`when`, `unless`, `case` 等）

### 5.2 模块系统
- [ ] 实现模块导入/导出
- [ ] 支持标准库模块
- [ ] 文件加载机制

### 5.3 垃圾回收
- [ ] 实现标记-清除 GC
- [ ] 或实现引用计数 GC
- [ ] 内存管理优化

### 5.4 性能优化
- [ ] 字节码编译（可选）
- [ ] 常量折叠优化
- [ ] 内联优化

## 测试策略

### 单元测试
- [x] 词法分析器测试
- [x] 语法分析器测试  
- [x] 求值器核心功能测试
- [x] 内置函数测试

### 集成测试
- [x] 端到端解释器测试
- [x] REPL 功能测试
- [x] 错误处理测试

### Scheme 兼容性测试
- [ ] R5RS 标准测试用例
- [ ] 经典 Scheme 程序测试
- [ ] 性能基准测试

## 里程碑

1. **Alpha 版本** (第2阶段完成)：基本的 Scheme 求值器 - ✅ **已完成**
2. **Beta 版本** (第3阶段完成)：完整的内置函数库 - 🚧 **进行中**
3. **Release 1.0** (第4阶段完成)：功能完整的 Scheme 解释器 - 🚧 **进行中**
4. **Release 2.0** (第5阶段完成)：扩展功能和优化

## 当前状态 (2025-07-28)

### ✅ 已完成的核心功能
- **完整的词法分析器**：支持所有基本 Token 类型、注释、转义字符
- **完整的语法分析器**：支持 S-表达式、嵌套列表、引用语法
- **核心求值器**：支持自求值表达式、变量查找、函数调用
- **特殊形式**：`quote`, `if`, `lambda`, `let`, `begin`
- **内置函数**：基本算术 (`+`, `-`, `*`, `/`)、比较 (`=`, `<`)、列表操作 (`cons`, `car`, `cdr`, `list`)、类型谓词 (`null?`, `pair?`, `number?`, `string?`, `symbol?`)
- **REPL 系统**：交互式和批处理模式、错误处理、管道输入支持
- **完整的测试覆盖**：每个模块都有对应的单元测试

### 🚧 当前已知问题
1. **环境变量修改问题**：`define` 特殊形式因为 `Rc` 不可变性无法实现，需要重构为 `Rc<RefCell<Environment>>`
2. **位置信息缺失**：词法分析器不跟踪行号/列号，错误报告不够详细
3. **部分内置函数缺失**：`>`, `<=`, `>=`, `abs`, `max`, `min` 等
4. **高阶函数缺失**：`map`, `filter`, `fold` 等函数式编程核心函数

### 🎯 下一步优先级
1. **重构环境系统**：使用 `RefCell` 实现可变环境，修复 `define` 功能
2. **完善比较运算**：实现缺失的比较运算符
3. **添加逻辑运算**：实现 `and`, `or`, `cond` 特殊形式
4. **完善数学函数**：实现 `abs`, `max`, `min` 等数学运算

### 📊 完成度估算
- **第一阶段（基础架构）**：✅ 95% (缺位置信息)
- **第二阶段（核心求值器）**：🚧 85% (缺 `define` 和部分特殊形式)
- **第三阶段（内置函数库）**：🚧 60% (核心功能完成，需扩展)
- **第四阶段（高级特性）**：🚧 70% (REPL 完成，缺尾递归优化)

## 参考资料

- [Structure and Interpretation of Computer Programs](https://mitpress.mit.edu/sites/default/files/sicp/index.html)
- [The Scheme Programming Language](https://www.scheme.com/tspl4/)
- [Revised⁵ Report on Scheme](https://schemers.org/Documents/Standards/R5RS/)
- [Crafting Interpreters](https://craftinginterpreters.com/)
